# 前后端数据同步测试方案

**测试日期**: 2025-10-31  
**测试目标**: 验证后端管理平台的修改能否正确反映到前端用户页面

---

## 📋 测试概述

### 测试范围

| 功能 | 测试项 | 优先级 |
|------|--------|--------|
| 图片上传 | 产品图片、首页图片、OEM 图片 | 高 |
| 文字修改 | 产品描述、首页内容、公司信息 | 高 |
| 数据缓存 | 缓存清理、缓存更新 | 中 |
| 实时性 | 修改后是否立即生效 | 中 |

### 关键概念

**前端缓存机制**:
- 使用 localStorage 缓存产品数据
- 使用内存缓存 API 响应
- 缓存 TTL: 5 分钟
- 支持时间戳绕过缓存

**后端存储**:
- 产品数据存储在 D1 数据库
- 图片存储在 R2 对象存储
- 首页内容存储在 D1 数据库

---

## 🚀 启动步骤

### 步骤 1: 启动前端开发服务器

**终端 1**:
```bash
cd /Users/nll/Documents/可以用的网站
npm run dev
```

**预期输出**:
```
  VITE v5.x.x  ready in xxx ms
  ➜  Local:   http://localhost:5173/
```

### 步骤 2: 启动后端开发服务器

**终端 2**:
```bash
cd /Users/nll/Documents/可以用的网站
wrangler pages dev dist --local
```

**预期输出**:
```
✨ Compiled Worker successfully
⎔ Reloading local server...
```

### 步骤 3: 打开浏览器

- 前端用户页面: http://localhost:5173
- 后端管理平台: http://localhost:5173/admin
- 打开浏览器开发者工具 (F12)，切换到 Console 标签

---

## 🧪 测试场景 1: 产品图片上传测试

### 测试目标
验证在后端上传的产品图片能否在前端正确显示

### 测试步骤

#### 1.1 登录后端管理平台

```
1. 访问 http://localhost:5173/admin
2. 输入邮箱: admin@kn-wallpaperglue.com
3. 输入密码: Admin@123456
4. 点击登录
```

**预期结果**:
- ✅ 成功登录
- ✅ 进入管理平台首页

#### 1.2 进入产品管理页面

```
1. 点击左侧菜单 "产品管理"
2. 查看产品列表
```

**预期结果**:
- ✅ 显示产品列表
- ✅ 每个产品显示当前图片

#### 1.3 编辑产品并上传新图片

```
1. 点击某个产品的"编辑"按钮
2. 在产品编辑页面，找到"产品图片"字段
3. 点击"上传图片"按钮
4. 选择一张本地图片文件（推荐 JPG 或 PNG，大小 < 5MB）
5. 等待上传完成
6. 点击"保存"按钮
```

**预期结果**:
- ✅ 图片上传成功
- ✅ 显示上传进度
- ✅ 上传完成后显示图片预览
- ✅ 保存成功，显示成功提示

#### 1.4 验证前端是否显示新图片

```
1. 打开新标签页，访问 http://localhost:5173
2. 进入"产品"页面
3. 查找刚才编辑的产品
4. 检查产品图片是否是新上传的图片
```

**预期结果**:
- ✅ 前端显示新上传的图片
- ✅ 图片 URL 是 R2 存储的 URL（https://pub-*.r2.dev/...）
- ✅ 图片能正确加载，不出现 404

#### 1.5 验证图片 URL 格式

在浏览器开发者工具中：

```javascript
// 在 Console 中运行
// 查看产品图片 URL
document.querySelectorAll('img').forEach(img => {
  console.log('图片 URL:', img.src);
  console.log('是否是 R2 URL:', img.src.includes('r2.dev'));
});
```

**预期结果**:
- ✅ 图片 URL 包含 `r2.dev`
- ✅ 图片能正确加载

---

## 🧪 测试场景 2: 产品文字修改测试

### 测试目标
验证在后端修改的产品文字能否在前端正确显示

### 测试步骤

#### 2.1 编辑产品文字

```
1. 在后端管理平台，进入产品管理
2. 点击某个产品的"编辑"按钮
3. 修改以下字段之一：
   - 产品名称（中文）
   - 产品描述（中文）
   - 产品特性（中文）
4. 记下修改的内容（例如：在描述末尾添加 "[测试时间戳]"）
5. 点击"保存"按钮
```

**预期结果**:
- ✅ 保存成功，显示成功提示
- ✅ 后端返回 200 状态码

#### 2.2 验证前端是否显示修改

**方式 1: 刷新页面**

```
1. 打开前端用户页面 http://localhost:5173
2. 进入"产品"页面
3. 按 F5 或 Cmd+R 刷新页面
4. 查找刚才编辑的产品
5. 检查产品名称或描述是否已更新
```

**预期结果**:
- ✅ 刷新后显示新的文字内容
- ✅ 修改立即生效

**方式 2: 不刷新页面**

```
1. 在后端修改产品文字
2. 不刷新前端页面
3. 等待 5 秒钟
4. 检查前端页面是否自动更新
```

**预期结果**:
- ⚠️ 可能需要刷新页面才能看到更新（因为有缓存）
- ✅ 刷新后显示新内容

#### 2.3 验证缓存清理

在浏览器开发者工具中：

```javascript
// 在 Console 中运行
// 清理 localStorage 缓存
localStorage.removeItem('products-cache');
console.log('✅ 缓存已清理');

// 重新加载产品数据
location.reload();
```

**预期结果**:
- ✅ 清理缓存后，刷新页面显示最新数据

---

## 🧪 测试场景 3: 首页内容修改测试

### 测试目标
验证在后端修改的首页内容能否在前端正确显示

### 测试步骤

#### 3.1 编辑首页内容

```
1. 在后端管理平台，进入"首页内容"管理
2. 修改以下内容之一：
   - 首页标题
   - 首页副标题
   - 首页描述
3. 记下修改的内容
4. 点击"保存"按钮
```

**预期结果**:
- ✅ 保存成功

#### 3.2 验证前端是否显示修改

```
1. 打开前端首页 http://localhost:5173
2. 按 F5 刷新页面
3. 检查首页内容是否已更新
```

**预期结果**:
- ✅ 刷新后显示新的首页内容

---

## 🧪 测试场景 4: OEM 图片上传测试

### 测试目标
验证在后端上传的 OEM 图片能否在前端正确显示

### 测试步骤

#### 4.1 编辑 OEM 内容

```
1. 在后端管理平台，进入"OEM 服务"管理
2. 找到"OEM 图片"字段
3. 点击"上传图片"按钮
4. 选择一张本地图片文件
5. 等待上传完成
6. 点击"保存"按钮
```

**预期结果**:
- ✅ 图片上传成功
- ✅ 保存成功

#### 4.2 验证前端是否显示新图片

```
1. 打开前端首页 http://localhost:5173
2. 向下滚动到 OEM 服务部分
3. 检查 OEM 图片是否是新上传的图片
```

**预期结果**:
- ✅ 前端显示新上传的 OEM 图片

---

## 🔍 数据流验证

### 验证产品数据流

在浏览器开发者工具中：

```javascript
// 1. 查看前端获取的产品数据
fetch('/api/products?_t=' + Date.now())
  .then(r => r.json())
  .then(data => {
    console.log('📦 前端获取的产品数据:', data);
    console.log('产品数:', data.data?.length);
    console.log('第一个产品:', data.data?.[0]);
  });

// 2. 查看缓存数据
const cached = localStorage.getItem('products-cache');
console.log('📦 缓存的产品数据:', JSON.parse(cached || '{}'));

// 3. 查看 API 响应时间
console.time('API 响应时间');
fetch('/api/products')
  .then(r => r.json())
  .then(data => {
    console.timeEnd('API 响应时间');
    console.log('✅ API 响应成功');
  });
```

### 验证图片 URL

```javascript
// 查看所有图片 URL
document.querySelectorAll('img').forEach((img, index) => {
  console.log(`图片 ${index}:`, {
    src: img.src,
    alt: img.alt,
    isR2: img.src.includes('r2.dev'),
    isLoaded: img.complete && img.naturalHeight > 0
  });
});
```

---

## 📊 测试结果记录

### 测试 1: 产品图片上传

| 步骤 | 预期结果 | 实际结果 | 状态 |
|------|---------|---------|------|
| 上传图片 | 成功 | | ✅/❌ |
| 保存产品 | 成功 | | ✅/❌ |
| 前端显示 | 显示新图片 | | ✅/❌ |
| 图片 URL | R2 URL | | ✅/❌ |

### 测试 2: 产品文字修改

| 步骤 | 预期结果 | 实际结果 | 状态 |
|------|---------|---------|------|
| 修改文字 | 成功 | | ✅/❌ |
| 保存产品 | 成功 | | ✅/❌ |
| 刷新后显示 | 显示新文字 | | ✅/❌ |
| 缓存清理 | 显示最新数据 | | ✅/❌ |

### 测试 3: 首页内容修改

| 步骤 | 预期结果 | 实际结果 | 状态 |
|------|---------|---------|------|
| 修改内容 | 成功 | | ✅/❌ |
| 保存内容 | 成功 | | ✅/❌ |
| 刷新后显示 | 显示新内容 | | ✅/❌ |

### 测试 4: OEM 图片上传

| 步骤 | 预期结果 | 实际结果 | 状态 |
|------|---------|---------|------|
| 上传图片 | 成功 | | ✅/❌ |
| 保存 OEM | 成功 | | ✅/❌ |
| 前端显示 | 显示新图片 | | ✅/❌ |

---

## 🐛 常见问题排查

### 问题 1: 前端显示旧数据

**症状**: 修改后端数据，前端仍显示旧数据

**原因**: 缓存未清理

**解决方案**:
```javascript
// 清理所有缓存
localStorage.clear();
location.reload();
```

### 问题 2: 图片显示 404

**症状**: 图片 URL 正确，但显示 404

**原因**: R2 存储桶未配置或图片未上传成功

**解决方案**:
1. 检查 R2 存储桶配置
2. 查看后端日志
3. 重新上传图片

### 问题 3: API 返回 401

**症状**: 修改数据时返回 401 Unauthorized

**原因**: Token 过期或无效

**解决方案**:
1. 重新登录
2. 检查 Token 是否正确保存
3. 查看浏览器 localStorage 中的 `admin-token`

---

## 📝 测试报告模板

**测试日期**: ___________  
**测试人员**: ___________  
**测试环境**: 本地开发环境

### 总体结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 产品图片上传 | ✅/❌ | |
| 产品文字修改 | ✅/❌ | |
| 首页内容修改 | ✅/❌ | |
| OEM 图片上传 | ✅/❌ | |

### 发现的问题

1. ___________
2. ___________
3. ___________

### 建议

1. ___________
2. ___________
3. ___________

---

**生成时间**: 2025-10-31

