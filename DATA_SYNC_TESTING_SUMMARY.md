# 前后端数据同步测试 - 完整指南

**生成时间**: 2025-10-31  
**测试目标**: 验证后端管理平台的修改能否正确反映到前端用户页面

---

## 📚 测试资源清单

我为你创建了以下测试资源：

### 1. 📖 详细测试计划
**文件**: `DATA_SYNC_TESTING_PLAN.md`

包含：
- 4 个完整的测试场景
- 详细的步骤说明
- 预期结果
- 常见问题排查
- 测试结果记录表

### 2. 🧪 自动化测试脚本
**文件**: `test-data-sync.js`

功能：
- 自动运行 8 个测试用例
- 验证后端服务状态
- 测试登录、产品、首页、OEM、审计日志等 API
- 生成测试报告

**使用方法**:
```bash
node test-data-sync.js
```

### 3. 🌐 交互式测试页面
**文件**: `public/test-data-sync.html`

功能：
- 图形化测试界面
- 实时测试结果显示
- 数据验证工具
- 缓存管理
- 日志查看

**访问方法**:
```
http://localhost:5173/test-data-sync.html
```

---

## 🚀 快速开始

### 步骤 1: 启动服务

**终端 1 - 启动前端**:
```bash
cd /Users/nll/Documents/可以用的网站
npm run dev
```

**终端 2 - 启动后端**:
```bash
cd /Users/nll/Documents/可以用的网站
wrangler pages dev dist --local
```

### 步骤 2: 选择测试方式

#### 方式 A: 使用自动化脚本（推荐快速验证）

```bash
node test-data-sync.js
```

**预期输出**:
```
==================================================
前后端数据同步测试
==================================================

🧪 测试 1: 检查后端服务是否运行
✅ 后端服务正常运行

🧪 测试 2: 管理员登录
✅ 登录成功，Token: eyJ...

🧪 测试 3: 获取产品列表
✅ 获取产品列表成功，共 5 个产品

...

==================================================
测试结果总结
==================================================
✅ 通过: 8
❌ 失败: 0
✅ 所有测试通过！(100%)
```

#### 方式 B: 使用交互式测试页面（推荐详细验证）

1. 打开浏览器访问: http://localhost:5173/test-data-sync.html
2. 点击"运行所有测试"按钮
3. 查看测试结果和统计数据
4. 使用"数据验证"工具检查具体数据

#### 方式 C: 手动测试（推荐完整验证）

按照 `DATA_SYNC_TESTING_PLAN.md` 中的步骤进行手动测试

---

## 🧪 测试场景概览

### 场景 1: 产品图片上传测试

**流程**:
```
后端上传图片 → 保存到 R2 → 前端获取并显示
```

**验证点**:
- ✅ 图片上传成功
- ✅ 图片 URL 正确（R2 URL）
- ✅ 前端能正确显示图片

### 场景 2: 产品文字修改测试

**流程**:
```
后端修改文字 → 保存到数据库 → 前端获取并显示
```

**验证点**:
- ✅ 文字修改成功
- ✅ 刷新后显示新文字
- ✅ 缓存正确清理

### 场景 3: 首页内容修改测试

**流程**:
```
后端修改首页内容 → 保存到数据库 → 前端获取并显示
```

**验证点**:
- ✅ 内容修改成功
- ✅ 刷新后显示新内容

### 场景 4: OEM 图片上传测试

**流程**:
```
后端上传 OEM 图片 → 保存到 R2 → 前端获取并显示
```

**验证点**:
- ✅ 图片上传成功
- ✅ 前端能正确显示图片

---

## 📊 数据流架构

```
┌─────────────────────────────────────────────────────────┐
│                    前端用户页面                          │
│              (http://localhost:5173)                    │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  产品列表 / 首页 / OEM 页面                       │  │
│  │  ├─ 获取产品数据 → /api/products                │  │
│  │  ├─ 获取首页内容 → /api/content                 │  │
│  │  └─ 获取 OEM 数据 → /api/oem                    │  │
│  └──────────────────────────────────────────────────┘  │
│                      ↑                                  │
│                   代理到                                │
│                      ↓                                  │
└─────────────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│                  后端 API 服务                          │
│              (http://localhost:8788)                   │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  公开 API                                        │  │
│  │  ├─ GET /api/products                           │  │
│  │  ├─ GET /api/content                            │  │
│  │  └─ GET /api/oem                                │  │
│  └──────────────────────────────────────────────────┘  │
│                      ↓                                  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  数据库 (D1)                                     │  │
│  │  ├─ products 表                                 │  │
│  │  ├─ page_contents 表                            │  │
│  │  └─ oem_services 表                             │  │
│  └──────────────────────────────────────────────────┘  │
│                      ↓                                  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  对象存储 (R2)                                   │  │
│  │  ├─ 产品图片                                    │  │
│  │  ├─ 首页图片                                    │  │
│  │  └─ OEM 图片                                    │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                       ↑
                   管理员修改
                       ↓
┌─────────────────────────────────────────────────────────┐
│                  后端管理平台                           │
│              (http://localhost:5173/admin)             │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  产品管理 / 首页管理 / OEM 管理                   │  │
│  │  ├─ 上传图片 → /api/upload-image                │  │
│  │  ├─ 修改产品 → /api/admin/products              │  │
│  │  ├─ 修改首页 → /api/admin/home-content          │  │
│  │  └─ 修改 OEM → /api/admin/oem                   │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 缓存机制

### 前端缓存

| 缓存类型 | 位置 | TTL | 清理方式 |
|---------|------|-----|---------|
| localStorage | 浏览器本地存储 | 永久 | 手动清理 |
| 内存缓存 | 内存 | 5 分钟 | 自动过期 |
| HTTP 缓存 | 浏览器缓存 | 10 分钟 | 时间戳绕过 |

### 绕过缓存的方法

```javascript
// 方法 1: 添加时间戳
fetch('/api/products?_t=' + Date.now())

// 方法 2: 添加 Cache-Control 头
fetch('/api/products', {
  headers: {
    'Cache-Control': 'no-cache, no-store, must-revalidate'
  }
})

// 方法 3: 清理 localStorage
localStorage.removeItem('products-cache');
location.reload();
```

---

## ✅ 测试检查清单

### 前置条件

- [ ] 前端服务已启动 (http://localhost:5173)
- [ ] 后端服务已启动 (http://localhost:8788)
- [ ] 浏览器开发者工具已打开 (F12)
- [ ] 已登录后端管理平台

### 产品图片上传

- [ ] 能成功上传图片
- [ ] 图片 URL 是 R2 URL
- [ ] 前端能显示新图片
- [ ] 刷新后仍能显示

### 产品文字修改

- [ ] 能成功修改文字
- [ ] 刷新后显示新文字
- [ ] 缓存能正确清理
- [ ] 多个产品修改互不影响

### 首页内容修改

- [ ] 能成功修改首页内容
- [ ] 刷新后显示新内容
- [ ] 所有语言版本都能修改

### OEM 图片上传

- [ ] 能成功上传 OEM 图片
- [ ] 前端能显示新图片
- [ ] 图片 URL 正确

---

## 🐛 常见问题

### Q1: 修改后前端仍显示旧数据

**原因**: 缓存未清理

**解决**:
```javascript
localStorage.clear();
location.reload();
```

### Q2: 图片显示 404

**原因**: R2 存储桶未配置或图片上传失败

**解决**:
1. 检查 wrangler.toml 中的 R2 配置
2. 查看后端日志
3. 重新上传图片

### Q3: API 返回 401

**原因**: Token 过期或无效

**解决**:
1. 重新登录
2. 检查 localStorage 中的 token

### Q4: 后端服务无法连接

**原因**: 后端服务未启动

**解决**:
```bash
wrangler pages dev dist --local
```

---

## 📈 性能指标

### 预期响应时间

| API | 响应时间 | 缓存 |
|-----|---------|------|
| 获取产品列表 | < 200ms | 5 分钟 |
| 获取首页内容 | < 100ms | 5 分钟 |
| 获取 OEM 数据 | < 100ms | 5 分钟 |
| 上传图片 | < 2s | 无 |
| 修改产品 | < 500ms | 无 |

---

## 📞 支持

如有问题，请：

1. 查看浏览器开发者工具的 Console 标签
2. 查看后端日志
3. 运行自动化测试脚本获取详细信息
4. 参考 `DATA_SYNC_TESTING_PLAN.md` 中的排查步骤

---

## 📝 测试记录

**测试日期**: ___________  
**测试人员**: ___________  
**测试结果**: ✅ 通过 / ❌ 失败

### 总体评分

| 项目 | 评分 |
|------|------|
| 产品图片上传 | ___/10 |
| 产品文字修改 | ___/10 |
| 首页内容修改 | ___/10 |
| OEM 图片上传 | ___/10 |
| 数据同步速度 | ___/10 |
| 缓存管理 | ___/10 |

### 发现的问题

1. ___________
2. ___________
3. ___________

### 建议

1. ___________
2. ___________
3. ___________

---

**生成时间**: 2025-10-31  
**版本**: 1.0

