<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>简单 API 测试</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .result {
            background: #2d2d2d;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .error {
            color: #f48771;
        }
        .success {
            color: #89d185;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
    </style>
</head>
<body>
    <h1>🔍 API 连接测试</h1>
    
    <button onclick="test1()">测试 1: 检查域名解析</button>
    <button onclick="test2()">测试 2: 检查 API 可访问性</button>
    <button onclick="test3()">测试 3: 测试登录 API</button>
    <button onclick="test4()">测试 4: 查看详细错误</button>
    
    <div id="result"></div>
    
    <script>
        const log = (msg, isError = false) => {
            const div = document.getElementById('result');
            const p = document.createElement('div');
            p.className = 'result ' + (isError ? 'error' : 'success');
            p.textContent = msg;
            div.appendChild(p);
        };
        
        async function test1() {
            log('=== 测试 1: 检查域名解析 ===');
            try {
                const response = await fetch('https://kn-wallpaperglue.com', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                log('✅ 域名可以访问');
            } catch (error) {
                log('❌ 域名无法访问: ' + error.message, true);
            }
        }
        
        async function test2() {
            log('=== 测试 2: 检查 API 可访问性 ===');
            try {
                const response = await fetch('https://kn-wallpaperglue.com/api/products?limit=1');
                log('✅ API 可以访问');
                log('状态码: ' + response.status);
                const data = await response.json();
                log('返回数据: ' + JSON.stringify(data, null, 2));
            } catch (error) {
                log('❌ API 无法访问: ' + error.message, true);
                log('错误类型: ' + error.name, true);
                log('错误堆栈: ' + error.stack, true);
            }
        }
        
        async function test3() {
            log('=== 测试 3: 测试登录 API ===');
            try {
                const response = await fetch('https://kn-wallpaperglue.com/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@kn-wallpaperglue.com',
                        password: 'admin123'
                    })
                });
                
                log('✅ 请求成功');
                log('状态码: ' + response.status);
                
                const data = await response.json();
                log('返回数据: ' + JSON.stringify(data, null, 2));
                
                if (data.accessToken) {
                    log('✅ 获得 accessToken');
                }
                if (data.refreshToken) {
                    log('✅ 获得 refreshToken');
                }
                if (data.authType === 'JWT') {
                    log('✅ authType 是 JWT');
                } else {
                    log('⚠️ authType 是: ' + data.authType, true);
                }
                
            } catch (error) {
                log('❌ 请求失败: ' + error.message, true);
                log('错误类型: ' + error.name, true);
            }
        }
        
        async function test4() {
            log('=== 测试 4: 查看详细错误 ===');
            
            // 检查浏览器信息
            log('浏览器: ' + navigator.userAgent);
            log('在线状态: ' + (navigator.onLine ? '在线' : '离线'));
            
            // 尝试访问并捕获所有信息
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch('https://kn-wallpaperglue.com/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@kn-wallpaperglue.com',
                        password: 'admin123'
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                log('响应对象: ' + JSON.stringify({
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    type: response.type,
                    url: response.url,
                    headers: Array.from(response.headers.entries())
                }, null, 2));
                
                const text = await response.text();
                log('响应内容: ' + text);
                
            } catch (error) {
                log('❌ 详细错误信息:', true);
                log('错误消息: ' + error.message, true);
                log('错误名称: ' + error.name, true);
                log('错误类型: ' + error.constructor.name, true);
                
                if (error.name === 'AbortError') {
                    log('⚠️ 请求超时（10秒）', true);
                } else if (error.name === 'TypeError') {
                    log('⚠️ 网络错误或 CORS 问题', true);
                }
                
                log('完整错误对象: ' + JSON.stringify(error, Object.getOwnPropertyNames(error), 2), true);
            }
        }
        
        // 页面加载时自动运行测试
        window.addEventListener('load', () => {
            log('页面加载完成，准备测试...');
            log('当前时间: ' + new Date().toLocaleString());
            log('');
        });
    </script>
</body>
</html>

